<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>RouteScriptsExample - Bots Edi Translator Documentation</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="..">Bots Edi Translator Documentation</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="..">Home</a>
                    </li>
                
                
                
                    <li >
                        <a href="../AboutThisWiki/">AboutThisWiki</a>
                    </li>
                
                
                
                    <li >
                        <a href="../Archiving/">Archiving</a>
                    </li>
                
                
                
                    <li >
                        <a href="../BotsName/">BotsName</a>
                    </li>
                
                
                
                    <li >
                        <a href="../ChannelFileLock/">ChannelFileLock</a>
                    </li>
                
                
                
                    <li >
                        <a href="../ChannelPortNumbers/">ChannelPortNumbers</a>
                    </li>
                
                
                
                    <li >
                        <a href="../ChannelsDatabase/">ChannelsDatabase</a>
                    </li>
                
                
                
                    <li >
                        <a href="../ChannelsIntroduction/">ChannelsIntroduction</a>
                    </li>
                
                
                
                    <li >
                        <a href="../ChannelsRecipes/">ChannelsRecipes</a>
                    </li>
                
                
                
                    <li >
                        <a href="../ChannelsScripting/">ChannelsScripting</a>
                    </li>
                
                
                
                    <li >
                        <a href="../Charsets/">Charsets</a>
                    </li>
                
                
                
                    <li >
                        <a href="../CommunicationScriptsExample/">CommunicationScriptsExample</a>
                    </li>
                
                
                
                    <li >
                        <a href="../CommunicationScriptsSubclass/">CommunicationScriptsSubclass</a>
                    </li>
                
                
                
                    <li >
                        <a href="../CommunicationScriptsType/">CommunicationScriptsType</a>
                    </li>
                
                
                
                    <li >
                        <a href="../ConfigurationBotskey/">ConfigurationBotskey</a>
                    </li>
                
                
                
                    <li >
                        <a href="../ConfigurationCC/">ConfigurationCC</a>
                    </li>
                
                
                
                    <li >
                        <a href="../ConfigurationCharset/">ConfigurationCharset</a>
                    </li>
                
                
                
                    <li >
                        <a href="../ConfigurationDIY/">ConfigurationDIY</a>
                    </li>
                
                
                
                    <li >
                        <a href="../ConfigurationHow/">ConfigurationHow</a>
                    </li>
                
                
                
                    <li >
                        <a href="../ConfigurationMerge/">ConfigurationMerge</a>
                    </li>
                
                
                
                    <li >
                        <a href="../ConfigurationPartnerGroup/">ConfigurationPartnerGroup</a>
                    </li>
                
                
                
                    <li >
                        <a href="../ConfigurationPartners/">ConfigurationPartners</a>
                    </li>
                
                
                
                    <li >
                        <a href="../ConfigurationSplit/">ConfigurationSplit</a>
                    </li>
                
                
                
                    <li >
                        <a href="../ConfigurationSplitMerge/">ConfigurationSplitMerge</a>
                    </li>
                
                
                
                    <li >
                        <a href="../Confirmations/">Confirmations</a>
                    </li>
                
                
                
                    <li >
                        <a href="../DaemonProcesses/">DaemonProcesses</a>
                    </li>
                
                
                
                    <li >
                        <a href="../Debug/">Debug</a>
                    </li>
                
                
                
                    <li >
                        <a href="../DeploymentAS2/">DeploymentAS2</a>
                    </li>
                
                
                
                    <li >
                        <a href="../DeploymentAcceptance/">DeploymentAcceptance</a>
                    </li>
                
                
                
                    <li >
                        <a href="../DeploymentAdvanced/">DeploymentAdvanced</a>
                    </li>
                
                
                
                    <li >
                        <a href="../DeploymentAutopush/">DeploymentAutopush</a>
                    </li>
                
                
                
                    <li >
                        <a href="../DeploymentEngine/">DeploymentEngine</a>
                    </li>
                
                
                
                    <li >
                        <a href="../DeploymentEngineOverview/">DeploymentEngineOverview</a>
                    </li>
                
                
                
                    <li >
                        <a href="../DeploymentEngineReturnCode/">DeploymentEngineReturnCode</a>
                    </li>
                
                
                
                    <li >
                        <a href="../DeploymentEnv/">DeploymentEnv</a>
                    </li>
                
                
                
                    <li >
                        <a href="../DeploymentErrorReports/">DeploymentErrorReports</a>
                    </li>
                
                
                
                    <li >
                        <a href="../DeploymentHandleErrors/">DeploymentHandleErrors</a>
                    </li>
                
                
                
                    <li >
                        <a href="../DeploymentHttps/">DeploymentHttps</a>
                    </li>
                
                
                
                    <li >
                        <a href="../DeploymentIntroduction/">DeploymentIntroduction</a>
                    </li>
                
                
                
                    <li >
                        <a href="../DeploymentMultipleEnvironments/">DeploymentMultipleEnvironments</a>
                    </li>
                
                
                
                    <li >
                        <a href="../DeploymentMultipleEnvironmentsVirtual/">DeploymentMultipleEnvironmentsVirtual</a>
                    </li>
                
                
                
                    <li >
                        <a href="../DeploymentOtherDatabase/">DeploymentOtherDatabase</a>
                    </li>
                
                
                
                    <li >
                        <a href="../DeploymentSettimezone/">DeploymentSettimezone</a>
                    </li>
                
                
                
                    <li >
                        <a href="../DeploymentTestSet/">DeploymentTestSet</a>
                    </li>
                
                
                
                    <li >
                        <a href="../DeploymentWebserver/">DeploymentWebserver</a>
                    </li>
                
                
                
                    <li >
                        <a href="../DirMonitor/">DirMonitor</a>
                    </li>
                
                
                
                    <li >
                        <a href="../EnvelopeScripting/">EnvelopeScripting</a>
                    </li>
                
                
                
                    <li >
                        <a href="../EnvelopeScriptsExample/">EnvelopeScriptsExample</a>
                    </li>
                
                
                
                    <li >
                        <a href="../Filenames/">Filenames</a>
                    </li>
                
                
                
                    <li >
                        <a href="../Glossary/">Glossary</a>
                    </li>
                
                
                
                    <li >
                        <a href="../GrammarsHowToGet/">GrammarsHowToGet</a>
                    </li>
                
                
                
                    <li >
                        <a href="../GrammarsIntroduction/">GrammarsIntroduction</a>
                    </li>
                
                
                
                    <li >
                        <a href="../GrammarsNextmessage/">GrammarsNextmessage</a>
                    </li>
                
                
                
                    <li >
                        <a href="../GrammarsNextmessageblock/">GrammarsNextmessageblock</a>
                    </li>
                
                
                
                    <li >
                        <a href="../GrammarsPartnerSyntax/">GrammarsPartnerSyntax</a>
                    </li>
                
                
                
                    <li >
                        <a href="../GrammarsRecorddefs/">GrammarsRecorddefs</a>
                    </li>
                
                
                
                    <li >
                        <a href="../GrammarsStructure/">GrammarsStructure</a>
                    </li>
                
                
                
                    <li >
                        <a href="../GrammarsSyntax/">GrammarsSyntax</a>
                    </li>
                
                
                
                    <li >
                        <a href="../Jobqueue/">Jobqueue</a>
                    </li>
                
                
                
                    <li >
                        <a href="../Links/">Links</a>
                    </li>
                
                
                
                    <li >
                        <a href="../LinuxDaemons/">LinuxDaemons</a>
                    </li>
                
                
                
                    <li >
                        <a href="../MappingCalculate/">MappingCalculate</a>
                    </li>
                
                
                
                    <li >
                        <a href="../MappingCcode/">MappingCcode</a>
                    </li>
                
                
                
                    <li >
                        <a href="../MappingChangedelete/">MappingChangedelete</a>
                    </li>
                
                
                
                    <li >
                        <a href="../MappingEAN/">MappingEAN</a>
                    </li>
                
                
                
                    <li >
                        <a href="../MappingFunction/">MappingFunction</a>
                    </li>
                
                
                
                    <li >
                        <a href="../MappingGet/">MappingGet</a>
                    </li>
                
                
                
                    <li >
                        <a href="../MappingGetput/">MappingGetput</a>
                    </li>
                
                
                
                    <li >
                        <a href="../MappingHowMappingWorks/">MappingHowMappingWorks</a>
                    </li>
                
                
                
                    <li >
                        <a href="../MappingIntroduction/">MappingIntroduction</a>
                    </li>
                
                
                
                    <li >
                        <a href="../MappingPartnerLookup/">MappingPartnerLookup</a>
                    </li>
                
                
                
                    <li >
                        <a href="../MappingPersist/">MappingPersist</a>
                    </li>
                
                
                
                    <li >
                        <a href="../MappingPut/">MappingPut</a>
                    </li>
                
                
                
                    <li >
                        <a href="../MappingRecipes/">MappingRecipes</a>
                    </li>
                
                
                
                    <li >
                        <a href="../Migrate/">Migrate</a>
                    </li>
                
                
                
                    <li >
                        <a href="../Migrate210/">Migrate210</a>
                    </li>
                
                
                
                    <li >
                        <a href="../Migrate220/">Migrate220</a>
                    </li>
                
                
                
                    <li >
                        <a href="../Migrate300/">Migrate300</a>
                    </li>
                
                
                
                    <li >
                        <a href="../Migrate310/">Migrate310</a>
                    </li>
                
                
                
                    <li >
                        <a href="../Migrate320/">Migrate320</a>
                    </li>
                
                
                
                    <li >
                        <a href="../MigrateDatabase/">MigrateDatabase</a>
                    </li>
                
                
                
                    <li >
                        <a href="../MigrateDjango/">MigrateDjango</a>
                    </li>
                
                
                
                    <li >
                        <a href="../MigrateKidGenshi/">MigrateKidGenshi</a>
                    </li>
                
                
                
                    <li >
                        <a href="../MonitorIntroduction/">MonitorIntroduction</a>
                    </li>
                
                
                
                    <li >
                        <a href="../MonitorRereceive/">MonitorRereceive</a>
                    </li>
                
                
                
                    <li >
                        <a href="../NewToPython/">NewToPython</a>
                    </li>
                
                
                
                    <li >
                        <a href="../OdooIntegration/">OdooIntegration</a>
                    </li>
                
                
                
                    <li >
                        <a href="../OverviewConfiguration/">OverviewConfiguration</a>
                    </li>
                
                
                
                    <li >
                        <a href="../OverviewDetail/">OverviewDetail</a>
                    </li>
                
                
                
                    <li >
                        <a href="../OverviewDirectoryLayout/">OverviewDirectoryLayout</a>
                    </li>
                
                
                
                    <li >
                        <a href="../OverviewIntroduction/">OverviewIntroduction</a>
                    </li>
                
                
                
                    <li >
                        <a href="../Performance/">Performance</a>
                    </li>
                
                
                
                    <li >
                        <a href="../PluginDetail/">PluginDetail</a>
                    </li>
                
                
                
                    <li >
                        <a href="../PluginGenerate/">PluginGenerate</a>
                    </li>
                
                
                
                    <li >
                        <a href="../PluginInstall/">PluginInstall</a>
                    </li>
                
                
                
                    <li >
                        <a href="../PluginIntroduction/">PluginIntroduction</a>
                    </li>
                
                
                
                    <li >
                        <a href="../PluginList/">PluginList</a>
                    </li>
                
                
                
                    <li >
                        <a href="../ProjectHome/">ProjectHome</a>
                    </li>
                
                
                
                    <li class="active">
                        <a href="./">RouteScriptsExample</a>
                    </li>
                
                
                
                    <li >
                        <a href="../RouteScriptsExampleBotsEngine/">RouteScriptsExampleBotsEngine</a>
                    </li>
                
                
                
                    <li >
                        <a href="../RouteScriptsExampleWholeRoute/">RouteScriptsExampleWholeRoute</a>
                    </li>
                
                
                
                    <li >
                        <a href="../RouteScriptsOverviewExits/">RouteScriptsOverviewExits</a>
                    </li>
                
                
                
                    <li >
                        <a href="../RoutesAttributes/">RoutesAttributes</a>
                    </li>
                
                
                
                    <li >
                        <a href="../RoutesComposite/">RoutesComposite</a>
                    </li>
                
                
                
                    <li >
                        <a href="../RoutesIntroduction/">RoutesIntroduction</a>
                    </li>
                
                
                
                    <li >
                        <a href="../RoutesPass/">RoutesPass</a>
                    </li>
                
                
                
                    <li >
                        <a href="../RoutesRecipes/">RoutesRecipes</a>
                    </li>
                
                
                
                    <li >
                        <a href="../RoutesScripts/">RoutesScripts</a>
                    </li>
                
                
                
                    <li >
                        <a href="../SideNavigation/">SideNavigation</a>
                    </li>
                
                
                
                    <li >
                        <a href="../SplitandMerge/">SplitandMerge</a>
                    </li>
                
                
                
                    <li >
                        <a href="../StartConfigurationFiles/">StartConfigurationFiles</a>
                    </li>
                
                
                
                    <li >
                        <a href="../StartGetBotsRunning/">StartGetBotsRunning</a>
                    </li>
                
                
                
                    <li >
                        <a href="../StartInstallDependencies/">StartInstallDependencies</a>
                    </li>
                
                
                
                    <li >
                        <a href="../StartInstallFaq/">StartInstallFaq</a>
                    </li>
                
                
                
                    <li >
                        <a href="../StartInstallProcedure/">StartInstallProcedure</a>
                    </li>
                
                
                
                    <li >
                        <a href="../StartInstallWindows/">StartInstallWindows</a>
                    </li>
                
                
                
                    <li >
                        <a href="../StartInstalllinux/">StartInstalllinux</a>
                    </li>
                
                
                
                    <li >
                        <a href="../StartIntroduction/">StartIntroduction</a>
                    </li>
                
                
                
                    <li >
                        <a href="../StartMyFirstPlugin/">StartMyFirstPlugin</a>
                    </li>
                
                
                
                    <li >
                        <a href="../StartMyFirstPluginDepth/">StartMyFirstPluginDepth</a>
                    </li>
                
                
                
                    <li >
                        <a href="../StartMyFirstPluginResults/">StartMyFirstPluginResults</a>
                    </li>
                
                
                
                    <li >
                        <a href="../StartMyFirstPluginSetup/">StartMyFirstPluginSetup</a>
                    </li>
                
                
                
                    <li >
                        <a href="../TranslationAlt/">TranslationAlt</a>
                    </li>
                
                
                
                    <li >
                        <a href="../TranslationDetail/">TranslationDetail</a>
                    </li>
                
                
                
                    <li >
                        <a href="../TranslationIntroduction/">TranslationIntroduction</a>
                    </li>
                
                
                
                    <li >
                        <a href="../TranslationRecipes/">TranslationRecipes</a>
                    </li>
                
                
                
                    <li >
                        <a href="../TranslationRules/">TranslationRules</a>
                    </li>
                
                
                
                    <li >
                        <a href="../TranslationVersions/">TranslationVersions</a>
                    </li>
                
                
                
                    <li >
                        <a href="../TranslationperPartner/">TranslationperPartner</a>
                    </li>
                
                
                
                    <li >
                        <a href="../TranslationperPartnerExtended/">TranslationperPartnerExtended</a>
                    </li>
                
                
                
                    <li >
                        <a href="../Translations/">Translations</a>
                    </li>
                
                
                
                    <li >
                        <a href="../Troubleshooting/">Troubleshooting</a>
                    </li>
                
                
                
                    <li >
                        <a href="../TutorialAdvanceShipNotice/">TutorialAdvanceShipNotice</a>
                    </li>
                
                
                
                    <li >
                        <a href="../TutorialEdiBasics/">TutorialEdiBasics</a>
                    </li>
                
                
                
                    <li >
                        <a href="../TutorialHighLevelBusinessFlow/">TutorialHighLevelBusinessFlow</a>
                    </li>
                
                
                
                    <li >
                        <a href="../TutorialHome/">TutorialHome</a>
                    </li>
                
                
                
                    <li >
                        <a href="../TutorialInvoice/">TutorialInvoice</a>
                    </li>
                
                
                
                    <li >
                        <a href="../TutorialPurchaseOrder/">TutorialPurchaseOrder</a>
                    </li>
                
                
                
                    <li >
                        <a href="../TutorialPurchaseOrderAck/">TutorialPurchaseOrderAck</a>
                    </li>
                
                
                
                    <li >
                        <a href="../TutorialPurchaseOrderChange/">TutorialPurchaseOrderChange</a>
                    </li>
                
                
                
                    <li >
                        <a href="../UsefulTools/">UsefulTools</a>
                    </li>
                
                
                
                    <li >
                        <a href="../UserScriptingIntroduction/">UserScriptingIntroduction</a>
                    </li>
                
                
                
                    <li >
                        <a href="../UserSecurity/">UserSecurity</a>
                    </li>
                
                
                
                    <li >
                        <a href="../V300changes/">V300changes</a>
                    </li>
                
                
                
                    <li >
                        <a href="../V300migrate/">V300migrate</a>
                    </li>
                
                
                
                    <li >
                        <a href="../V300rcchanges/">V300rcchanges</a>
                    </li>
                
                
                
                    <li >
                        <a href="../V310changes/">V310changes</a>
                    </li>
                
                
                
                    <li >
                        <a href="../V310migrate/">V310migrate</a>
                    </li>
                
                
                
                    <li >
                        <a href="../V320changes/">V320changes</a>
                    </li>
                
                
                
                    <li >
                        <a href="../V320migrate/">V320migrate</a>
                    </li>
                
                
                
                    <li >
                        <a href="../WhereDoIStart/">WhereDoIStart</a>
                    </li>
                
                
                
                    <li >
                        <a href="../WindowsServices/">WindowsServices</a>
                    </li>
                
                
                
                    <li >
                        <a href="../XMLnamespace/">XMLnamespace</a>
                    </li>
                
                
                
                    <li >
                        <a href="../index_old/">Index old</a>
                    </li>
                
                
                
                    <li >
                        <a href="../sam/">Sam</a>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../ProjectHome/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../RouteScriptsExampleBotsEngine/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#preprocessing-and-postprocessing-examples">Preprocessing and Postprocessing examples</a></li>
        
            <li><a href="#example-1-discard-input-files-that-are-too-small">Example 1: Discard input files that are too small</a></li>
        
            <li><a href="#example-2-extract-data-from-pdf-file-to-csv">Example 2: Extract data from PDF file (to csv)</a></li>
        
            <li><a href="#example-3-manipulate-records-without-botsid">Example 3: Manipulate records without BOTSID</a></li>
        
            <li><a href="#example-4-sort-input-file">Example 4: Sort input file</a></li>
        
            <li><a href="#example-5-postprocessing">Example 5: Postprocessing</a></li>
        
            <li><a href="#example-6-preprocessing-an-encrypted-file">Example 6: Preprocessing an encrypted file</a></li>
        
            <li><a href="#example-7-preprocessing-to-ignoreremove-xml-namespaces">Example 7: Preprocessing to ignore/remove XML namespaces</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h2 id="preprocessing-and-postprocessing-examples">Preprocessing and Postprocessing examples</h2>
<p>Some recipes for preprocessing edi files.<br />
Plugin 'demo_preprocessing' at <a href="http://sourceforge.net/projects/bots/files/plugins/">the bots sourceforge
site</a> demonstrates
preprocessing.</p>
<h3 id="example-1-discard-input-files-that-are-too-small">Example 1: Discard input files that are too small</h3>
<pre><code>import os
import bots.preprocess as preprocess
from bots.botsconfig import *

def postincommunication(routedict,*args,**kwargs):
    ''' function is called after the communication in the route.'''
    preprocess.preprocess(routedict=routedict,function=discard_file)

def discard_file(ta_from,endstatus,*args,**kwargs):
    ''' discard files that are to small (zero files)''' 
    ta_from.synall()
    filesize = ta_from.filesize
    if filesize &lt; 100:    #filesize in bytes
        ta_from.update(statust=DONE)                       #statust=DONE: bots discards file, gives no errors.
    else:
        ta_to = ta_from.copyta(status=endstatus)           #make new transaction for bots database
        ta_to.update(statust=OK,filename=ta_from.filename) #update outmessage transaction (same) filename
</code></pre>
<h3 id="example-2-extract-data-from-pdf-file-to-csv">Example 2: Extract data from PDF file (to csv)</h3>
<pre><code># Extract data from PDF file (to csv)
# x_group: group text closer than this as one field (default 10)
# y_group: group lines closer than this as one line (default 5)
# password: if required

import bots.preprocess as preprocess

def postincommunication(routedict,*args,**kwargs):
    preprocess.preprocess(routedict,preprocess.extractpdf,x_group=12,y_group=3,password='secret')
</code></pre>
<h3 id="example-3-manipulate-records-without-botsid">Example 3: Manipulate records without BOTSID</h3>
<pre><code>import bots.preprocess as preprocess
import bots.botslib as botslib
import bots.botsglobal as botsglobal
from bots.botsconfig import *

def postincommunication(routedict,*args,**kwargs):
    preprocess.preprocess(routedict,custom_preprocess)

def custom_preprocess(ta_from,endstatus,*args,**kwargs):
    try:
        # copy ta for preprocessing
        ta_to = ta_from.copyta(status=endstatus)

        # open the files
        infile = botslib.opendata(ta_from.filename,'r')
        tofile = botslib.opendata(str(ta_to.idta),'wb')

        # preprocessing: read infile, write tofile
        # This file has headers and lines, but no field that can be used for BOTSID!
        # Determine the line type from the data, and add HDR or LIN in first column
        # Text heading lines and blank lines are omitted
        for line in infile:
            if '\tAU' in line: 
                tofile.write('HDR\t' + line)
            elif ('\tWAIT' in line or
                  '\tFULL' in line or
                  '\tEMPTY' in line):
                tofile.write('LIN\t' + line)

        infile.close()
        tofile.close()

        ta_to.update(statust=OK,filename=str(ta_to.idta)) #update outmessage transaction with ta_info; 
    except:
        txt=botslib.txtexc()
        botsglobal.logger.error(u'Custom preprocess failed. Error:\n%s',txt)
        raise botslib.InMessageError(u'Custom preprocess failed. Error:\n$error',error=txt)
</code></pre>
<h3 id="example-4-sort-input-file">Example 4: Sort input file</h3>
<pre><code>import bots.preprocess as preprocess
import bots.botslib as botslib
import bots.botsglobal as botsglobal
from bots.botsconfig import *

def postincommunication(routedict,*args,**kwargs):
    preprocess.preprocess(routedict,sort_file)

def sort_file(ta_from,endstatus,*args,**kwargs):
    try:
        # copy ta for preprocessing
        ta_to = ta_from.copyta(status=endstatus)

        # open the files
        infile = botslib.opendata(ta_from.filename,'r')
        tofile = botslib.opendata(str(ta_to.idta),'wb')

        # sort output
        lines = infile.readlines()
        lines.sort()
        for line in lines:
            tofile.write(line)

        infile.close()
        tofile.close()

        ta_to.update(statust=OK,filename=str(ta_to.idta)) #update outmessage transaction with ta_info; 
    except:
        txt=botslib.txtexc()
        botsglobal.logger.error(u'Sort preprocess failed. Error:\n%s',txt)
        raise botslib.InMessageError(u'Sort preprocess failed. Error:\n$error',error=txt)
</code></pre>
<h3 id="example-5-postprocessing">Example 5: Postprocessing</h3>
<p>Post processing works the same way as pre processing, except it is done
before out communication.</p>
<pre><code>import bots.preprocess as preprocess
import bots.botslib as botslib
import bots.botsglobal as botsglobal
from bots.botsconfig import *

def preoutcommunication(routedict,*args,**kwargs):
    preprocess.postprocess(routedict,split_lines)

def split_lines(ta_from,endstatus,,*args,**kwargs):
    try:
        # copy ta for postprocessing, open the files
        ta_to = ta_from.copyta(status=endstatus)
        infile = botslib.opendata(ta_from.filename,'r')
        tofile = botslib.opendata(str(ta_to.idta),'wb')

        # split every line at the first separator (space)
        # output the two parts on separate lines
        for line in infile:
            part = line.partition(' ')
            tofile.write(part[0] + '\n' + part[2])

        # close files and update outmessage transaction with ta_info
        infile.close()
        tofile.close()
        ta_to.update(statust=OK,filename=str(ta_to.idta))

    except:
        txt=botslib.txtexc()
        botsglobal.logger.error(_(u'split_lines postprocess failed. Error:\n%s'),txt)
        raise botslib.OutMessageError(_(u'split_lines postprocess failed. Error:\n$error'),error=txt)
</code></pre>
<h3 id="example-6-preprocessing-an-encrypted-file">Example 6: Preprocessing an encrypted file</h3>
<p>This example uses gnupg to decrypt a file before processing it in Bots.</p>
<pre><code>import bots.preprocess as preprocess
import bots.botslib as botslib
import gnupg

# Preprocessing - Decrypt infile using GPG
# Dependencies: python-gnupg-0.3.0
#   botssys/gnugpghome directory, containing:
#     gpg binary files (gpg.exe and iconv.dll)
#     keys (pubring.gpg, secring.gpg, trustdb.gpg)
#     passphrase.txt

def postincommunication(routedict,*args,**kwargs):
    # preprocess to decrypt, then passthrough (no translation)
    preprocess.preprocess(routedict,decrypt_GPG)
    transform.addinfo(change={'status':MERGED},where={'status':FILEIN,'idroute':routedict['idroute']})

def decrypt_GPG(ta_from,endstatus,*args,**kwargs):

    # copy ta for preprocessing
    ta_to = ta_from.copyta(status=endstatus)

    # gnupghome contains the gpg binary files, public/private keys, and passphrase
    gnupghome = botslib.join(botsglobal.ini.get('directories','botssys'),'gnupghome')
    passphrase = open(botslib.join(gnupghome,'passphrase.txt'),'r').read()
    gpgbinary = botslib.join(gnupghome,'gpg.exe')

    # Here is where we do the actual decryption
    gpg = gnupg.GPG(gnupghome=gnupghome,gpgbinary=gpgbinary)
    with botslib.opendata(ta_from.filename,'rb') as input:
        status = gpg.decrypt_file(input, passphrase=passphrase,output=botslib.abspathdata(str(ta_to.idta)))

    # log the results and finish
    botsglobal.logger.debug(status.stderr)
    if status.ok:
        botsglobal.logger.info(status.status)
        ta_to.update(statust=OK,filename=str(ta_to.idta))
    else:
        botsglobal.logger.error(status.status)
        ta_to.update(statust=ERROR,filename=str(ta_to.idta))
        raise PreprocessError(status.status + '\n' + status.stderr)

class PreprocessError(botslib.BotsError):
    pass
</code></pre>
<h3 id="example-7-preprocessing-to-ignoreremove-xml-namespaces">Example 7: Preprocessing to ignore/remove XML namespaces</h3>
<p>This example changes the default namespace to a namespace prefix (so it
is ignored). It also removes a namespace prefix (ENV). You may need to
use either or both of these methods, depending on the content of your
XML file.</p>
<pre><code>#-------------------------------------------------------------------------------
# preprocess - Remove XML namespaces to simplify grammar and mapping
# Generally Bots does not need to use the xmlns for incoming files
# This example handles both default and prefix namespaces

def postincommunication(routedict):

    def _preprocess(ta_from,endstatus,**argv):

        # copy ta for preprocessing
        ta_to = ta_from.copyta(status=endstatus)

        # open the files
        infile = botslib.opendata(ta_from.filename,'r')
        tofile = botslib.opendata(str(ta_to.idta),'wb')

        for line in infile:
            tofile.write(line.replace('xmlns=','xmlns:NOTUSED=').replace('&lt;ENV:','&lt;').replace('&lt;/ENV:','&lt;/'))

        # close files and update outmessage transaction
        infile.close()
        tofile.close()
        ta_to.update(statust=OK,filename=str(ta_to.idta))

    preprocess.preprocess(routedict,_preprocess)
</code></pre></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
